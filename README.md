# Building a SOC + Honeynet in Azure (Live Traffic)
![Cloud Honeynet / SOC](https://i.imgur.com/ZWxe03e.jpg)

## Introduction

In this project, I created a honeynet in Microsoft Azure and ingested log sources from various resources into a Log Analytics Workspace, which is then used by Microsoft Sentinel to build attack maps, trigger alerts, and create incidents. I measured some security metrics in the insecure environment for 24 hours, applied some security controls to harden the environment, and then measured the same metrics for another 24 hours. Those metrics are listed below:

- SecurityEvent (Windows Event Logs) - derived from the Windows Virtual Machine and it's installed MSSQL Server.
- Syslog (Linux Event Logs) - derived from the Linux Virtual Machine
- SecurityAlert (Log Analytics Alerts Triggered)
- SecurityIncident (Incidents created by Sentinel)
- AzureNetworkAnalytics_CL (Malicious Flows allowed into the honeynet

The architecture of the honeynet in Azure consisted of the following components:

- Virtual Network (VNet)
- Network Security Groups (NSG)
- Virtual Machines (2 windows, 1 linux)
- Log Analytics Workspace
- Azure Key Vault
- Azure Storage Account
- Microsoft Sentinel

When all the resources were originally deployed, they were very much exposed to the public internet. The Virtual Machines' Network Security Group rules, as well as the VM's built-in firewalls, were manually set to allow all traffic. The other resources were deployed with public endpoints visible to the Internet (No Use for Private Endpoints.) Any security incidents, such as unauthenticated (failed) logins, were configured to be ingested by Azure's Log Analytics Workspace (LAW). 

## Verified VM's Logs Will Be Ingested by Azure LAW
![Law Agents](https://i.imgur.com/EXyMv1e.jpg)

## Verified Failed Authentication Logs
![Failed Auth Windows VM](https://i.imgur.com/pUZIlV9.jpg)

## Architecture Before Hardening / Security Controls
![Architecture Diagram](https://i.imgur.com/aBDwnKb.jpg)

## Attack Maps Before Hardening / Security Controls
![Allowed Inbound Malicious Flows](https://i.imgur.com/Fx0yGRx.jpg)
![Linux Syslog Auth Failures](https://i.imgur.com/T0eKJEq.jpg)
![Windows RDP/SMB Auth Failures](https://i.imgur.com/Lq580BJ.jpg)
![MSSQL Auth Failures](https://i.imgur.com/0KwLg2Z.jpg)

A large number of security incidents were generated by Azure Sentinel, most of which were due to malicious attempts to log in to the Windows and Linux VMs, along with the MSSQL Server. These security incidents can be assigned, investigated and closed out. Investigating the incidents provides more information regarding what occurred and from what IP address(es) the attack originated from. Oftentimes the logs reflected that multiple attempts to log in were made by the same IP's, along with multiple IP addresses related by attack instance and region. 

## Failed Log on Incidents


## Metrics Before Hardening / Security Controls

The following table shows the metrics from the insecure environment measured for 24 hours:
Start Time 2023-04-27 18:42:41
Stop Time 2023-04-28 18:42:22

| Metric                   | Count
| ------------------------ | -----
| SecurityEvent            | 53,509
| Syslog                   | 5,210
| SecurityAlert            | 7
| SecurityIncident         | 382
| AzureNetworkAnalytics_CL | 927

After experiencing the results of the open honeynet, Network Security Groups were hardened by blocking ALL traffic with the exception of my workstation(IPv4 address). Public Access was also disabled in the resource-specific firewalls like in the Key Vault. Additionally, Microsoft Defender for Cloud was utilized to implement security controls recommended by NIST and by Microsoft.

## Implementing MS Recommended Security Controls
![MS Recommendations](https://i.imgur.com/AWgk3be.jpg)

## Architecture After Hardening / Security Controls
![Architecture Diagram](https://i.imgur.com/YQNa9Pp.jpg)

## Attack Maps After Hardening / Security Controls

```All map queries actually returned no results due to no instances of malicious activity for the 24 hour period after hardening.```

## Metrics After Hardening / Security Controls

The following table shows the same metrics for another 24 hours _after_ adding the basic aforementioned security controls to the environment:
Start Time 2023-04-29 15:00:37
Stop Time	2023-04-30 15:00:51

| Metric                   | Count
| ------------------------ | -----
| SecurityEvent            | 10,984
| Syslog                   | 24
| SecurityAlert            | 0
| SecurityIncident         | 0
| AzureNetworkAnalytics_CL | 0

## Conclusion

During this project, a honeynet was set up in Microsoft Azure, and log sources were integrated into a Log Analytics workspace. Azure Sentinal triggered alerts and created incidents based on the ingested logs. In addition, before and after implementing security measures, metrics were measured in the cloud network environment. It is worth mentioning that the effectiveness of the security controls was demonstrated by the significant reduction in the number of security events and incidents. However, if the network's resources were heavily utilized by regular users, there may have been an increase in security events and alerts in the 24 hours following the implementation of the security controls, such as large numbers of users logging in or failing to log in with the correct password.
